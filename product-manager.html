<!DOCTYPE html>
<html>
<head>
  <title>Materials</title>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <style>
    #product-search {
      margin: 20px;
    }
    #products {
      list-style-type: none;
      padding-left: 0;
    }
    #products li {
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div id="product-manager">
    <input type="text" id="search-input" placeholder="Search materials" />
    <ul id="products"></ul>
  </div>

  <script>
    var t = TrelloPowerUp.iframe();

    const mockProducts = [
      { id: '1', name: 'Material A' },
      { id: '2', name: 'Material B' },
      { id: '3', name: 'Material C' },
      { id: '4', name: 'Material D' }
    ];

    function searchProducts() {
      const searchTerm = document.getElementById('search-input').value.toLowerCase();
      const productList = document.getElementById('products');
      productList.innerHTML = ''; // Clear previous search results

      const filteredProducts = mockProducts.filter(product =>
        product.name.toLowerCase().includes(searchTerm)
      );

      filteredProducts.forEach(product => {
        const li = document.createElement('li');
        li.innerHTML = `
          ${product.name}
          <input type="number" min="1" id="quantity-${product.id}" value="1" style="width: 50px;" />
          <button onclick="addProductToCard('${product.id}', '${product.name}')">Add</button>
        `;
        productList.appendChild(li);
      });
    }

    function addProductToCard(productId, productName) {
      const quantity = document.getElementById(`quantity-${productId}`).value;
      t.get('card', 'shared', 'products', [])
        .then(products => {
          const existingProduct = products.find(p => p.id === productId);
          if (existingProduct) {
            existingProduct.quantity = parseInt(quantity);
          } else {
            products.push({ id: productId, name: productName, quantity: parseInt(quantity) });
          }
          return t.set('card', 'shared', 'products', products);
        })
        .then(() => t.closePopup()); // Close the popup
    }

    function removeProductFromCard(productId) {
      t.get('card', 'shared', 'products', [])
        .then(products => {
          const updatedProducts = products.filter(product => product.id !== productId);
          return t.set('card', 'shared', 'products', updatedProducts);
        })
        .then(() => t.closePopup()); // Close the popup
    }

    document.getElementById('search-input').addEventListener('input', searchProducts);

    // Pre-populate the product list if the card already has products
    t.get('card', 'shared', 'products', []).then(function(products) {
      const productList = document.getElementById('products');
      products.forEach(product => {
        const li = document.createElement('li');
        li.innerHTML = `
          ${product.name} (Quantity: <input type="number" min="1" id="quantity-${product.id}" value="${product.quantity}" style="width: 50px;" />)
          <button onclick="removeProductFromCard('${product.id}')">Remove</button>
        `;
        productList.appendChild(li);
      });
    });
  </script>
</body>
</html>
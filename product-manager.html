<!DOCTYPE html>
<html>
<head>
  <title>Materials</title>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <style>
    #product-search {
      margin: 20px;
    }
    #products, #added-products {
      list-style-type: none;
      padding-left: 0;
    }
    #products li, #added-products li {
      margin: 10px 0;
    }
    .quantity-input {
      width: 50px;
      margin-right: 10px;
    }
    .remove-btn {
      color: red;
      cursor: pointer;
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <div id="product-manager">
    <input type="text" id="search-input" placeholder="Busca materials pel nom" />
    <ul id="products"></ul>

    <h2>Materials afegits</h2>
    <ul id="added-products"></ul>
  </div>

  <script>
    var t = TrelloPowerUp.iframe();
    
    // Mocked product data (you can replace this with real data later)
    const mockProducts = [
      { id: '1', name: 'Material A' },
      { id: '2', name: 'Material B' },
      { id: '3', name: 'Material C' },
      { id: '4', name: 'Material D' }
    ];

    // Function to search products (mocked for now)
    function searchProducts() {
      const searchTerm = document.getElementById('search-input').value.toLowerCase();
      const productList = document.getElementById('products');
      productList.innerHTML = ''; // Clear previous search results

      const filteredProducts = mockProducts.filter(product => product.name.toLowerCase().includes(searchTerm));

      filteredProducts.forEach(product => {
        const li = document.createElement('li');
        li.innerHTML = `
          ${product.name}
          <button onclick="addProductToCard('${product.id}', '${product.name}')">Afegir</button>
        `;
        productList.appendChild(li);
      });
    }

    // Function to add the product to the Trello card with quantity
    function addProductToCard(productId, productName) {
      t.get('card', 'shared', 'products', [])
        .then(products => {
          products.push({ id: productId, name: productName, quantity: 1 });
          return t.set('card', 'shared', 'products', products);
        })
        .then(() => {
          loadAddedProducts(); // Reload the list after adding
        });
    }

    // Function to load the list of products added to the card
    function loadAddedProducts() {
      t.get('card', 'shared', 'products', [])
        .then(products => {
          const addedProductsList = document.getElementById('added-products');
          addedProductsList.innerHTML = '';

          products.forEach(product => {
            const li = document.createElement('li');
            li.innerHTML = `
              ${product.name}
              <input type="number" class="quantity-input" value="${product.quantity}" onchange="updateProductQuantity('${product.id}', this.value)" />
              <span class="remove-btn" onclick="removeProductFromCard('${product.id}')">Remove</span>
            `;
            addedProductsList.appendChild(li);
          });
        });
    }

    // Function to update the quantity of a product in the Trello card
    function updateProductQuantity(productId, newQuantity) {
      t.get('card', 'shared', 'products', [])
        .then(products => {
          const updatedProducts = products.map(product => {
            if (product.id === productId) {
              product.quantity = parseInt(newQuantity, 10); // Update quantity
            }
            return product;
          });
          return t.set('card', 'shared', 'products', updatedProducts);
        });
    }

    // Function to remove a product from the Trello card
    function removeProductFromCard(productId) {
      t.get('card', 'shared', 'products', [])
        .then(products => {
          const updatedProducts = products.filter(product => product.id !== productId);
          return t.set('card', 'shared', 'products', updatedProducts);
        })
        .then(() => {
          loadAddedProducts(); // Reload the list after removal
        });
    }

    // Listen for input changes (search as you type)
    document.getElementById('search-input').addEventListener('input', searchProducts);

    // Load the added products when the modal is opened
    t.render(function(){
      loadAddedProducts(); // Show materials already added to the card
    });
  </script>
</body>
</html>